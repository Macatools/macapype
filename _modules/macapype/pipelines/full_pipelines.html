<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>macapype.pipelines.full_pipelines &#8212; macapype 0.3.0.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.12.4.min.js "></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.4.1/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html"><span><img src="../../../_static/logo_macapype_0.3.jpg"></span>
          Macapype</a>
        <span class="navbar-text navbar-version pull-left"><b>0.3.0.2</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../auto_examples/index.html">Gallery</a></li>
                <li><a href="../../../api.html">API</a></li>
                <li><a href="../../../tutorial.html">Tutorial</a></li>
                <li><a href="../../../install.html">Installation</a></li>
                <li><a href="https://github.com/macatools/macapype">Github</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../install.html#dependancies">Dependancies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../install.html#external-software-dependancies">External software dependancies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../install.html#python-packages-dependancies">Python packages dependancies</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../install.html#creating-environment-with-all-packages">Creating environment with all packages</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../install.html#install-macapype-package">Install macapype package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../install.html#from-github">from github</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../install.html#using-git">Using git</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../install.html#using-pip">Using pip</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../install.html#from-pypi">from pypi</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../install.html#from-conda">From conda</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../install.html#testing-the-install">Testing the install</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../docker_install.html">Docker install</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../docker_install.html#dockerfile">Dockerfile</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../docker_install.html#docker-image">Docker image</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../docker_install.html#note-on-spm-docker">Note on SPM Docker</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows.html">How to run workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../params.html">Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../indiv_params.html">Individual Parameters</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../indiv_params.html#adding-indiv">Adding -indiv</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../indiv_params.html#list-of-indiv-params-recap">List of indiv params (recap):</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../indiv_params.html#data-preparation-ants-ants-t1-spm-spm-t1">Data preparation (ANTS, ANTS_T1, SPM, SPM_T1)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../indiv_params.html#spm-based-pipelines-spm-and-spm-t1">SPM based pipelines (SPM and SPM_T1)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../indiv_params.html#ants-based-pipelines">ANTS based pipelines</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorial.html#changing-parameters">Changing parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorial.html#adding-a-parameter-to-a-node-absent-from-params-json">Adding a parameter to a node absent from params.json</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../tutorial.html#the-old-fashioned-way">the “old fashioned” way:</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../tutorial.html#the-semi-dirty-way">the “semi-dirty” way</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../tutorial.html#the-new-way-using-nodeparams">the new way: using NodeParams</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../tutorial.html#new-multi-params">New: multi_params</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorial.html#modifying-an-existing-pipeline">Modifying an existing pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorial.html#wrapping-new-nodes">Wrapping new nodes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Pipeline examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples.html#macaque">Macaque:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples.html#marmoset">Marmoset:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples.html#baboon">Baboon:</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../pipelines.html">Pipelines</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../pipelines.html#spm-based-pipelines">SPM-based pipelines</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pipelines.html#using-t1w-and-t2w-images">Using T1w and T2w images</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pipelines.html#using-only-a-t1w-image">Using only a T1w image</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../pipelines.html#ants-based-pipelines">ANTS-based pipelines</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pipelines.html#id2">Using T1w and T2w images</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pipelines.html#using-only-t1w-images">Using only T1w images</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../pipelines.html#data-preparation">Data preparation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../pipelines.html#short-data-preparation">Short data preparation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pipelines.html#long-data-preparation">Long data preparation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../pipelines.html#options">Options</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../pipelines.html#reorient-sub-pipeline">Reorient sub-pipeline</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../pipelines.html#denoise-and-denoise-first">Denoise and denoise_first</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../external_pipeline.html">External Pipelines</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../external_pipeline.html#macaque-diffusion-weighted-imaging">Macaque diffusion weighted imaging</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../external_pipeline.html#how-to-create-a-whole-brain-tractogram">How to create a whole brain tractogram?</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../external_pipeline.html#perform-conversion-between-different-file-types">Perform conversion between different file types</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../external_pipeline.html#generation-of-a-whole-brain-mask-from-a-dwi-image">Generation of a whole brain mask from a DWI image</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../external_pipeline.html#diffusion-tensor-estimation">Diffusion tensor estimation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../external_pipeline.html#maps-generation-of-tensor-derived-parameters">Maps Generation of tensor-derived parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../external_pipeline.html#constrained-spherical-deconvolution-csd">Constrained spherical deconvolution (CSD)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../external_pipeline.html#fod-estimation">FOD estimation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../external_pipeline.html#convertion-of-the-macaque-t1-in-mif-file">Convertion of the macaque T1 in .mif file</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../external_pipeline.html#generation-of-a-volume-which-contain-the-probability-to-be-on-the-gm-wm-interface">Generation of a volume which contain the probability to be on the gm-wm interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../external_pipeline.html#perform-streamlines-tractography">Perform streamlines tractography</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../external_pipeline.html#reduction-of-the-fibers-number">Reduction of the fibers number</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../external_pipeline.html#estimation-of-the-registration-of-two-images-together-using-a-symmetric-rigid-transformation-model">Estimation of the registration of two images together using a symmetric rigid transformation model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../external_pipeline.html#application-of-the-spatial-transformations-to-an-image">Application of the spatial transformations to an image</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribute.html">How to contribute to the sources of the project</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../contribute.html#install-a-dev-version">Install a dev version</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../contribute.html#to-build-the-documentation">To build the documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../contribute.html#pull-request">Pull Request</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../contribute.html#versionning">Versionning</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../utils.html">Useful tips (before processing)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../utils.html#how-to-orient-the-labels-your-images">How to orient the labels your images ?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../utils.html#how-to-tilt-the-orientation-of-your-images">How to tilt the orientation of your images ?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../utils.html#nudging-the-image-with-fsleyes">Nudging the image with FSLEyes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../utils.html#in-fsleyes">In FSLEyes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../utils.html#apply-the-nudge-transfo-to-the-orig-image">Apply the nudge transfo to the Orig image</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../utils.html#rename-everything-back-as-intended-in-bids">rename everything back as intended in BIDS</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../utils.html#how-to-compute-cropping-parameters">How to compute cropping parameters ?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../brainhack.html">Events</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../brainhack.html#brainhack-marseille-2021">BrainHack Marseille 2021</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../brainhack.html#channels-of-communication">Channels of communication</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../brainhack.html#during-the-event">during the event</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../brainhack.html#before-after-the-event">before/after the event</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../brainhack.html#project-pages">Project pages:</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../brainhack.html#program">Program:</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docker_install.html">Docker install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows.html">How to run workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../params.html">Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../indiv_params.html">Individual Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Pipeline examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pipelines.html">Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../external_pipeline.html">External Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribute.html">How to contribute to the sources of the project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../utils.html">Useful tips (before processing)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../brainhack.html">Events</a></li>
</ul>
</ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docker_install.html">Docker install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows.html">How to run workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../params.html">Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../indiv_params.html">Individual Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Pipeline examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pipelines.html">Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../external_pipeline.html">External Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribute.html">How to contribute to the sources of the project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../utils.html">Useful tips (before processing)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../brainhack.html">Events</a></li>
</ul>

<form action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <h1>Source code for macapype.pipelines.full_pipelines</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gather all full pipelines</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.utility</span> <span class="k">as</span> <span class="nn">niu</span>
<span class="kn">import</span> <span class="nn">nipype.pipeline.engine</span> <span class="k">as</span> <span class="nn">pe</span>

<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">fsl</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">ants</span>

<span class="kn">from</span> <span class="nn">..utils.utils_nodes</span> <span class="kn">import</span> <span class="n">NodeParams</span>

<span class="kn">from</span> <span class="nn">macapype.nodes.correct_bias</span> <span class="kn">import</span> <span class="n">T1xT2BiasFieldCorrection</span>
<span class="kn">from</span> <span class="nn">macapype.nodes.register</span> <span class="kn">import</span> <span class="n">IterREGBET</span>
<span class="kn">from</span> <span class="nn">macapype.nodes.prepare</span> <span class="kn">import</span> <span class="n">padding_cropped_img</span>

<span class="kn">from</span> <span class="nn">.prepare</span> <span class="kn">import</span> <span class="p">(</span><span class="n">create_short_preparation_pipe</span><span class="p">,</span>
                      <span class="n">create_short_preparation_FLAIR_pipe</span><span class="p">,</span>
                      <span class="n">create_short_preparation_MD_pipe</span><span class="p">,</span>
                      <span class="n">create_short_preparation_T1_pipe</span><span class="p">,</span>
                      <span class="n">create_long_multi_preparation_pipe</span><span class="p">,</span>
                      <span class="n">create_long_single_preparation_pipe</span><span class="p">,)</span>

<span class="kn">from</span> <span class="nn">.segment</span> <span class="kn">import</span> <span class="p">(</span><span class="n">create_old_segment_pipe</span><span class="p">,</span>
                      <span class="n">create_native_old_segment_pipe</span><span class="p">,</span>
                      <span class="n">create_segment_atropos_pipe</span><span class="p">,</span>
                      <span class="n">create_segment_atropos_seg_pipe</span><span class="p">,</span>
                      <span class="n">create_mask_from_seg_pipe</span><span class="p">,</span>
                      <span class="n">create_5tt_pipe</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">.correct_bias</span> <span class="kn">import</span> <span class="p">(</span><span class="n">create_masked_correct_bias_pipe</span><span class="p">,</span>
                           <span class="n">create_correct_bias_pipe</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">.register</span> <span class="kn">import</span> <span class="p">(</span><span class="n">create_register_NMT_pipe</span><span class="p">,</span> <span class="n">create_reg_seg_pipe</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">.extract_brain</span> <span class="kn">import</span> <span class="p">(</span><span class="n">create_extract_pipe</span><span class="p">,</span>
                            <span class="n">create_extract_T1_pipe</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">.surface</span> <span class="kn">import</span> <span class="n">create_nii_to_mesh_pipe</span><span class="p">,</span> <span class="n">create_nii_to_mesh_fs_pipe</span>

<span class="kn">from</span> <span class="nn">macapype.utils.misc</span> <span class="kn">import</span> <span class="n">parse_key</span><span class="p">,</span> <span class="n">list_input_files</span><span class="p">,</span> <span class="n">show_files</span>


<span class="c1">###############################################################################</span>
<span class="c1"># SPM based segmentation (from: Régis Trapeau)</span>
<span class="c1"># -soft SPM or SPM_T1</span>
<span class="c1">###############################################################################</span>
<div class="viewcode-block" id="create_full_spm_subpipes"><a class="viewcode-back" href="../../../generated/macapype.pipelines.full_pipelines.create_full_spm_subpipes.html#macapype.pipelines.full_pipelines.create_full_spm_subpipes">[docs]</a><span class="k">def</span> <span class="nf">create_full_spm_subpipes</span><span class="p">(</span>
        <span class="n">params_template</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;full_spm_subpipes&#39;</span><span class="p">,</span>
        <span class="n">pad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">space</span><span class="o">=</span><span class="s1">&#39;template&#39;</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; Description: SPM based segmentation pipeline from T1w and T2w images</span>
<span class="sd">    in template space</span>

<span class="sd">    Processing steps:</span>

<span class="sd">    - Data preparation (short, with betcrop or crop)</span>
<span class="sd">    - debias using T1xT2BiasFieldCorrection (using mask is betcrop)</span>
<span class="sd">    - registration to template file with IterREGBET</span>
<span class="sd">    - SPM segmentation the old way (SPM8, not dartel based)</span>

<span class="sd">    Params:</span>

<span class="sd">    - short_data_preparation_pipe (see :class:`create_short_preparation_pipe \</span>
<span class="sd">    &lt;macapype.pipelines.prepare.create_short_preparation_pipe&gt;`)</span>
<span class="sd">    - debias (see :class:`T1xT2BiasFieldCorrection \</span>
<span class="sd">    &lt;macapype.nodes.correct_bias.T1xT2BiasFieldCorrection&gt;`) - also available \</span>
<span class="sd">    as :ref:`indiv_params &lt;indiv_params&gt;`</span>
<span class="sd">    - reg (see :class:`IterREGBET &lt;macapype.nodes.register.IterREGBET&gt;`) - \</span>
<span class="sd">    also available as :ref:`indiv_params &lt;indiv_params&gt;`</span>
<span class="sd">    - native_old_segment_pipe (see :class:`create_native_old_segment_pipe \</span>
<span class="sd">    &lt;macapype.pipelines.segment.create_old_segment_pipe&gt;`)</span>

<span class="sd">    Inputs:</span>

<span class="sd">        inputnode:</span>

<span class="sd">            list_T1:</span>
<span class="sd">                T1 file names</span>

<span class="sd">            list_T2:</span>
<span class="sd">                T2 file names</span>

<span class="sd">            indiv_params (opt):</span>
<span class="sd">                dict with individuals parameters for some nodes</span>


<span class="sd">        arguments:</span>

<span class="sd">            params_template:</span>
<span class="sd">                dict of template files containing brain_template and priors \</span>
<span class="sd">            (list of template based segmented tissues)</span>

<span class="sd">            params:</span>
<span class="sd">                dictionary of node sub-parameters (from a json file)</span>

<span class="sd">            name:</span>
<span class="sd">                pipeline name (default = &quot;full_spm_subpipes&quot;)</span>

<span class="sd">    Outputs:</span>

<span class="sd">            old_segment_pipe.thresh_gm.out_file:</span>
<span class="sd">                segmented grey matter in template space</span>

<span class="sd">            old_segment_pipe.thresh_wm.out_file:</span>
<span class="sd">                segmented white matter in template space</span>

<span class="sd">            old_segment_pipe.thresh_csf.out_file:</span>
<span class="sd">                segmented csf in template space</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Full pipeline name: &quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="c1"># Creating pipeline</span>
    <span class="n">seg_pipe</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Creating input node</span>
    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;list_T1&#39;</span><span class="p">,</span> <span class="s1">&#39;list_T2&#39;</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span>
    <span class="p">)</span>

    <span class="c1"># output node</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;segmented_brain_mask&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">)</span>
    <span class="c1"># preprocessing</span>
    <span class="k">if</span> <span class="s1">&#39;long_single_preparation_pipe&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">data_preparation_pipe</span> <span class="o">=</span> <span class="n">create_long_single_preparation_pipe</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;long_single_preparation_pipe&quot;</span><span class="p">))</span>

    <span class="k">elif</span> <span class="s1">&#39;long_multi_preparation_pipe&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">data_preparation_pipe</span> <span class="o">=</span> <span class="n">create_long_multi_preparation_pipe</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;long_multi_preparation_pipe&quot;</span><span class="p">))</span>

    <span class="k">elif</span> <span class="s1">&#39;short_preparation_pipe&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">data_preparation_pipe</span> <span class="o">=</span> <span class="n">create_short_preparation_pipe</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;short_preparation_pipe&quot;</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error, short_preparation_pipe, long_single_preparation_pipe or</span><span class="se">\</span>
<span class="s2">            long_multi_preparation_pipe was not found in params, skipping&quot;</span><span class="p">)</span>

        <span class="n">test_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;list_T1&#39;</span><span class="p">,</span> <span class="s1">&#39;list_T2&#39;</span><span class="p">],</span>
                                         <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span>
                                         <span class="n">function</span><span class="o">=</span><span class="n">list_input_files</span><span class="p">),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;test_node&quot;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;list_T1&#39;</span><span class="p">,</span>
                         <span class="n">test_node</span><span class="p">,</span> <span class="s1">&#39;list_T1&#39;</span><span class="p">)</span>
        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;list_T2&#39;</span><span class="p">,</span>
                         <span class="n">test_node</span><span class="p">,</span> <span class="s1">&#39;list_T2&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">seg_pipe</span>

    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;list_T1&#39;</span><span class="p">,</span>
                     <span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.list_T1&#39;</span><span class="p">)</span>
    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;list_T2&#39;</span><span class="p">,</span>
                     <span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.list_T2&#39;</span><span class="p">)</span>
    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span>
                     <span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.indiv_params&#39;</span><span class="p">)</span>

    <span class="c1"># Bias correction of cropped images</span>
    <span class="n">debias</span> <span class="o">=</span> <span class="n">NodeParams</span><span class="p">(</span><span class="n">T1xT2BiasFieldCorrection</span><span class="p">(),</span>
                        <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;debias&quot;</span><span class="p">),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;debias&#39;</span><span class="p">)</span>

    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.preproc_T1&#39;</span><span class="p">,</span>
                     <span class="n">debias</span><span class="p">,</span> <span class="s1">&#39;t1_file&#39;</span><span class="p">)</span>
    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.preproc_T2&#39;</span><span class="p">,</span>
                     <span class="n">debias</span><span class="p">,</span> <span class="s1">&#39;t2_file&#39;</span><span class="p">)</span>
    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span> <span class="n">parse_key</span><span class="p">,</span> <span class="s2">&quot;debias&quot;</span><span class="p">),</span>
                     <span class="n">debias</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;bet_crop&#39;</span> <span class="ow">in</span> <span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;short_preparation_pipe&quot;</span><span class="p">):</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;bet_crop.mask_file&#39;</span><span class="p">,</span>
                         <span class="n">debias</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">debias</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">bet</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">pad</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Padding mask in native space&quot;</span><span class="p">)</span>

        <span class="n">pad_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
            <span class="n">niu</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
                <span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cropped_img_file&#39;</span><span class="p">,</span> <span class="s1">&#39;orig_img_file&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;indiv_crop&#39;</span><span class="p">],</span>
                <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;padded_img_file&#39;</span><span class="p">],</span>
                <span class="n">function</span><span class="o">=</span><span class="n">padding_cropped_img</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;pad_mask&quot;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">debias</span><span class="p">,</span> <span class="s1">&#39;debiased_mask_file&#39;</span><span class="p">,</span>
                         <span class="n">pad_mask</span><span class="p">,</span> <span class="s2">&quot;cropped_img_file&quot;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s2">&quot;av_T1.avg_img&quot;</span><span class="p">,</span>
                         <span class="n">pad_mask</span><span class="p">,</span> <span class="s2">&quot;orig_img_file&quot;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s2">&quot;indiv_params&quot;</span><span class="p">,</span> <span class="n">pad_mask</span><span class="p">,</span> <span class="s2">&quot;indiv_crop&quot;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">pad_mask</span><span class="p">,</span> <span class="s2">&quot;padded_img_file&quot;</span><span class="p">,</span>
                         <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;brain_mask&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">debias</span><span class="p">,</span> <span class="s1">&#39;debiased_mask_file&#39;</span><span class="p">,</span>
                         <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;brain_mask&quot;</span><span class="p">)</span>

    <span class="c1"># Iterative registration to the INIA19 template</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="n">NodeParams</span><span class="p">(</span><span class="n">IterREGBET</span><span class="p">(),</span>
                     <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;reg&quot;</span><span class="p">),</span>
                     <span class="n">name</span><span class="o">=</span><span class="s1">&#39;reg&#39;</span><span class="p">)</span>

    <span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">refb_file</span> <span class="o">=</span> <span class="n">params_template</span><span class="p">[</span><span class="s2">&quot;template_brain&quot;</span><span class="p">]</span>

    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">debias</span><span class="p">,</span> <span class="s1">&#39;t1_debiased_file&#39;</span><span class="p">,</span>
                     <span class="n">reg</span><span class="p">,</span> <span class="s1">&#39;inw_file&#39;</span><span class="p">)</span>

    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">debias</span><span class="p">,</span> <span class="s1">&#39;t1_debiased_brain_file&#39;</span><span class="p">,</span>
                     <span class="n">reg</span><span class="p">,</span> <span class="s1">&#39;inb_file&#39;</span><span class="p">)</span>

    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span> <span class="n">parse_key</span><span class="p">,</span> <span class="s2">&quot;reg&quot;</span><span class="p">),</span>
                     <span class="n">reg</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">)</span>

    <span class="c1"># Compute brain mask using old_segment of SPM and postprocessing on</span>
    <span class="c1"># tissues&#39; masks</span>
    <span class="k">if</span> <span class="s2">&quot;old_segment_pipe&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No segmentation, skipping&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">seg_pipe</span>

    <span class="k">if</span> <span class="n">space</span> <span class="o">==</span> <span class="s2">&quot;template&quot;</span><span class="p">:</span>

        <span class="n">old_segment_pipe</span> <span class="o">=</span> <span class="n">create_old_segment_pipe</span><span class="p">(</span>
            <span class="n">params_template</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;old_segment_pipe&quot;</span><span class="p">))</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="s1">&#39;warp_file&#39;</span><span class="p">,</span>
                         <span class="n">old_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.T1&#39;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span>
                         <span class="n">old_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.indiv_params&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">space</span> <span class="o">==</span> <span class="s2">&quot;native&quot;</span><span class="p">:</span>

        <span class="n">old_segment_pipe</span> <span class="o">=</span> <span class="n">create_native_old_segment_pipe</span><span class="p">(</span>
            <span class="n">params_template</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;old_segment_pipe&quot;</span><span class="p">))</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="s1">&#39;warp_file&#39;</span><span class="p">,</span>
                         <span class="n">old_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.T1&#39;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="s1">&#39;inv_transfo_file&#39;</span><span class="p">,</span>
                         <span class="n">old_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.inv_transfo_file&#39;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">debias</span><span class="p">,</span> <span class="s1">&#39;t1_debiased_brain_file&#39;</span><span class="p">,</span>
                         <span class="n">old_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.native_T1&#39;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span>
                         <span class="n">old_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.indiv_params&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error, space=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">space</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">seg_pipe</span>

    <span class="k">if</span> <span class="s2">&quot;mask_from_seg_pipe&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

        <span class="n">mask_from_seg_pipe</span> <span class="o">=</span> <span class="n">create_mask_from_seg_pipe</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;mask_from_seg_pipe&quot;</span><span class="p">))</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">old_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.threshold_csf&#39;</span><span class="p">,</span>
                         <span class="n">mask_from_seg_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.mask_csf&#39;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">old_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.threshold_wm&#39;</span><span class="p">,</span>
                         <span class="n">mask_from_seg_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.mask_wm&#39;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">old_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.threshold_gm&#39;</span><span class="p">,</span>
                         <span class="n">mask_from_seg_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.mask_gm&#39;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span>
                         <span class="n">mask_from_seg_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.indiv_params&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pad</span> <span class="ow">and</span> <span class="n">space</span> <span class="o">==</span> <span class="s2">&quot;native&quot;</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Padding seg mask in native space&quot;</span><span class="p">)</span>

            <span class="n">pad_seg_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                <span class="n">niu</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
                    <span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cropped_img_file&#39;</span><span class="p">,</span> <span class="s1">&#39;orig_img_file&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;indiv_crop&#39;</span><span class="p">],</span>
                    <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;padded_img_file&#39;</span><span class="p">],</span>
                    <span class="n">function</span><span class="o">=</span><span class="n">padding_cropped_img</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;pad_seg_mask&quot;</span><span class="p">)</span>

            <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">mask_from_seg_pipe</span><span class="p">,</span>
                             <span class="s1">&#39;merge_indexed_mask.indexed_mask&#39;</span><span class="p">,</span>
                             <span class="n">pad_seg_mask</span><span class="p">,</span> <span class="s2">&quot;cropped_img_file&quot;</span><span class="p">)</span>

            <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s2">&quot;av_T1.avg_img&quot;</span><span class="p">,</span>
                             <span class="n">pad_seg_mask</span><span class="p">,</span> <span class="s2">&quot;orig_img_file&quot;</span><span class="p">)</span>

            <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s2">&quot;indiv_params&quot;</span><span class="p">,</span>
                             <span class="n">pad_seg_mask</span><span class="p">,</span> <span class="s2">&quot;indiv_crop&quot;</span><span class="p">)</span>

            <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">pad_seg_mask</span><span class="p">,</span> <span class="s2">&quot;padded_img_file&quot;</span><span class="p">,</span>
                             <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;segmented_brain_mask&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">mask_from_seg_pipe</span><span class="p">,</span>
                             <span class="s1">&#39;merge_indexed_mask.indexed_mask&#39;</span><span class="p">,</span>
                             <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;segmented_brain_mask&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;template&#39;</span><span class="p">:</span>

        <span class="c1"># not mandatory</span>
        <span class="k">if</span> <span class="s2">&quot;nii_to_mesh_fs_pipe&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">nii_to_mesh_fs_pipe</span> <span class="o">=</span> <span class="n">create_nii_to_mesh_fs_pipe</span><span class="p">(</span>
                <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;nii_to_mesh_fs_pipe&quot;</span><span class="p">))</span>

            <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="s1">&#39;warp_file&#39;</span><span class="p">,</span>
                             <span class="n">nii_to_mesh_fs_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.reg_brain_file&#39;</span><span class="p">)</span>

            <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">old_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.threshold_wm&#39;</span><span class="p">,</span>
                             <span class="n">nii_to_mesh_fs_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.wm_mask_file&#39;</span><span class="p">)</span>

            <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span>
                             <span class="n">nii_to_mesh_fs_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.indiv_params&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">seg_pipe</span></div>


<span class="c1">###############################################################################</span>
<span class="c1"># FLAIR after SPM based segmentation</span>
<span class="c1"># -soft SPM_FLAIR or SPM_T1_FLAIR</span>
<span class="c1">###############################################################################</span>
<span class="k">def</span> <span class="nf">create_transfo_FLAIR_pipe</span><span class="p">(</span><span class="n">params_template</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span>
                              <span class="n">name</span><span class="o">=</span><span class="s1">&#39;transfo_FLAIR_pipe&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Description: apply tranformation to FLAIR, MD and FA if necssary</span>

<span class="sd">    Processing steps:</span>

<span class="sd">    - -coreg FA on T1</span>
<span class="sd">    - apply coreg on MD</span>
<span class="sd">    - debias using T1xT2BiasFieldCorrection (using mask is betcrop)</span>
<span class="sd">    - registration to template file with IterREGBET</span>
<span class="sd">    - SPM segmentation the old way (SPM8, not dartel based)</span>

<span class="sd">    Params:</span>

<span class="sd">    - short_data_preparation_pipe (see :class:`create_short_preparation_pipe \</span>
<span class="sd">    &lt;macapype.pipelines.prepare.create_short_preparation_pipe&gt;`)</span>
<span class="sd">    - debias (see :class:`T1xT2BiasFieldCorrection \</span>
<span class="sd">    &lt;macapype.nodes.correct_bias.T1xT2BiasFieldCorrection&gt;`) - also available \</span>
<span class="sd">    as :ref:`indiv_params &lt;indiv_params&gt;`</span>
<span class="sd">    - reg (see :class:`IterREGBET &lt;macapype.nodes.register.IterREGBET&gt;`) - \</span>
<span class="sd">    also available as :ref:`indiv_params &lt;indiv_params&gt;`</span>
<span class="sd">    - old_segment_pipe (see :class:`create_old_segment_pipe \</span>
<span class="sd">    &lt;macapype.pipelines.segment.create_old_segment_pipe&gt;`)</span>
<span class="sd">    - nii_to_mesh_fs_pipe (see :class:`create_nii_to_mesh_fs_pipe \</span>
<span class="sd">    &lt;macapype.pipelines.surface.create_nii_to_mesh_fs_pipe&gt;`)</span>

<span class="sd">    Inputs:</span>

<span class="sd">        inputnode:</span>

<span class="sd">            SS_T1:</span>
<span class="sd">                T1 file names</span>

<span class="sd">            orig_T1:</span>
<span class="sd">                T2 file names</span>

<span class="sd">            FLAIR:</span>
<span class="sd">                flair file name</span>

<span class="sd">            transfo_file:</span>
<span class="sd">                Transformation file between native to template</span>

<span class="sd">            inv_transfo_file:</span>
<span class="sd">                Transformation file between template and native</span>

<span class="sd">            threshold_wm:</span>
<span class="sd">                gm binary tissue in template space</span>

<span class="sd">            indiv_params (opt):</span>
<span class="sd">                dict with individuals parameters for some nodes</span>

<span class="sd">        outputnode:</span>

<span class="sd">            coreg_FLAIR:</span>
<span class="sd">                FLAIR coregistered to T1</span>

<span class="sd">            norm_FLAIR:</span>
<span class="sd">                FLAIR normalised in template space</span>

<span class="sd">        arguments:</span>

<span class="sd">            params_template:</span>
<span class="sd">                dict of template files containing brain_template and priors \</span>
<span class="sd">            (list of template based segmented tissues)</span>

<span class="sd">            params:</span>
<span class="sd">                dictionary of node sub-parameters (from a json file)</span>

<span class="sd">            name:</span>
<span class="sd">                pipeline name (default = &quot;full_spm_subpipes&quot;)</span>

<span class="sd">    Outputs:</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transfo FLAIR pipe name: &quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="c1"># Creating pipeline</span>
    <span class="n">transfo_pipe</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Creating input node</span>
    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;orig_T1&#39;</span><span class="p">,</span> <span class="s1">&#39;FLAIR&#39;</span><span class="p">,</span> <span class="s1">&#39;lin_transfo_file&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span>
    <span class="p">)</span>

    <span class="n">data_preparation_pipe</span> <span class="o">=</span> <span class="n">create_short_preparation_FLAIR_pipe</span><span class="p">(</span>
        <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;short_preparation_FLAIR_pipe&quot;</span><span class="p">))</span>

    <span class="n">transfo_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;orig_T1&#39;</span><span class="p">,</span>
                         <span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.orig_T1&#39;</span><span class="p">)</span>
    <span class="n">transfo_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;FLAIR&#39;</span><span class="p">,</span>
                         <span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.FLAIR&#39;</span><span class="p">)</span>

    <span class="c1"># apply norm to FLAIR</span>
    <span class="n">norm_lin_FLAIR</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">fsl</span><span class="o">.</span><span class="n">ApplyXFM</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;norm_lin_FLAIR&quot;</span><span class="p">)</span>
    <span class="n">norm_lin_FLAIR</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">params_template</span><span class="p">[</span><span class="s2">&quot;template_brain&quot;</span><span class="p">]</span>

    <span class="n">transfo_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.coreg_FLAIR&#39;</span><span class="p">,</span>
                         <span class="n">norm_lin_FLAIR</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
    <span class="n">transfo_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;lin_transfo_file&#39;</span><span class="p">,</span>
                         <span class="n">norm_lin_FLAIR</span><span class="p">,</span> <span class="s1">&#39;in_matrix_file&#39;</span><span class="p">)</span>

    <span class="c1"># Creating output node</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;coreg_FLAIR&#39;</span><span class="p">,</span> <span class="s1">&#39;norm_FLAIR&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span>
    <span class="p">)</span>

    <span class="n">transfo_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.coreg_FLAIR&#39;</span><span class="p">,</span>
                         <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;coreg_FLAIR&#39;</span><span class="p">)</span>

    <span class="n">transfo_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">norm_lin_FLAIR</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                         <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;norm_FLAIR&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">transfo_pipe</span>


<span class="c1"># SPM with MD</span>
<span class="k">def</span> <span class="nf">create_transfo_MD_pipe</span><span class="p">(</span><span class="n">params_template</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;transfo_MD_pipe&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Description: apply tranformation to FLAIR, MD and FA if necssary</span>

<span class="sd">    Processing steps:</span>

<span class="sd">    - -coreg FA on T1</span>
<span class="sd">    - apply coreg on MD</span>
<span class="sd">    - debias using T1xT2BiasFieldCorrection (using mask is betcrop)</span>
<span class="sd">    - registration to template file with IterREGBET</span>
<span class="sd">    - SPM segmentation the old way (SPM8, not dartel based)</span>

<span class="sd">    Params:</span>

<span class="sd">    - short_data_preparation_pipe (see :class:`create_short_preparation_pipe \</span>
<span class="sd">    &lt;macapype.pipelines.prepare.create_short_preparation_pipe&gt;`)</span>
<span class="sd">    - debias (see :class:`T1xT2BiasFieldCorrection \</span>
<span class="sd">    &lt;macapype.nodes.correct_bias.T1xT2BiasFieldCorrection&gt;`) - also available \</span>
<span class="sd">    as :ref:`indiv_params &lt;indiv_params&gt;`</span>
<span class="sd">    - reg (see :class:`IterREGBET &lt;macapype.nodes.register.IterREGBET&gt;`) - \</span>
<span class="sd">    also available as :ref:`indiv_params &lt;indiv_params&gt;`</span>
<span class="sd">    - old_segment_pipe (see :class:`create_old_segment_pipe \</span>
<span class="sd">    &lt;macapype.pipelines.segment.create_old_segment_pipe&gt;`)</span>
<span class="sd">    - nii_to_mesh_fs_pipe (see :class:`create_nii_to_mesh_fs_pipe \</span>
<span class="sd">    &lt;macapype.pipelines.surface.create_nii_to_mesh_fs_pipe&gt;`)</span>

<span class="sd">    Inputs:</span>

<span class="sd">        inputnode:</span>

<span class="sd">            SS_T1:</span>
<span class="sd">                T1 file names</span>

<span class="sd">            orig_T1:</span>
<span class="sd">                T2 file names</span>

<span class="sd">            FLAIR:</span>
<span class="sd">                flair file name</span>

<span class="sd">            transfo_file:</span>
<span class="sd">                Transformation file between native to template</span>

<span class="sd">            inv_transfo_file:</span>
<span class="sd">                Transformation file between template and native</span>

<span class="sd">            threshold_wm:</span>
<span class="sd">                gm binary tissue in template space</span>

<span class="sd">            indiv_params (opt):</span>
<span class="sd">                dict with individuals parameters for some nodes</span>


<span class="sd">        arguments:</span>

<span class="sd">            params_template:</span>
<span class="sd">                dict of template files containing brain_template and priors \</span>
<span class="sd">            (list of template based segmented tissues)</span>

<span class="sd">            params:</span>
<span class="sd">                dictionary of node sub-parameters (from a json file)</span>

<span class="sd">            name:</span>
<span class="sd">                pipeline name (default = &quot;full_spm_subpipes&quot;)</span>

<span class="sd">    Outputs:</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transfo MD pipe name: &quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="c1"># Creating pipeline</span>
    <span class="n">transfo_pipe</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Creating input node</span>
    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;orig_T1&#39;</span><span class="p">,</span> <span class="s1">&#39;SS_T2&#39;</span><span class="p">,</span> <span class="s1">&#39;MD&#39;</span><span class="p">,</span> <span class="s1">&#39;b0mean&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;threshold_wm&#39;</span><span class="p">,</span> <span class="s1">&#39;lin_transfo_file&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;inv_lin_transfo_file&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span>
    <span class="p">)</span>

    <span class="n">compute_native_wm</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">fsl</span><span class="o">.</span><span class="n">ApplyXFM</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;compute_native_wm&#39;</span><span class="p">)</span>

    <span class="n">transfo_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;threshold_wm&#39;</span><span class="p">,</span>
                         <span class="n">compute_native_wm</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">transfo_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;orig_T1&#39;</span><span class="p">,</span>
                         <span class="n">compute_native_wm</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">)</span>

    <span class="n">transfo_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;inv_lin_transfo_file&#39;</span><span class="p">,</span>
                         <span class="n">compute_native_wm</span><span class="p">,</span> <span class="s1">&#39;in_matrix_file&#39;</span><span class="p">)</span>

    <span class="n">data_preparation_pipe</span> <span class="o">=</span> <span class="n">create_short_preparation_MD_pipe</span><span class="p">(</span>
        <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;short_preparation_MD_pipe&quot;</span><span class="p">))</span>

    <span class="n">transfo_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;SS_T2&#39;</span><span class="p">,</span>
                         <span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.SS_T2&#39;</span><span class="p">)</span>
    <span class="n">transfo_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;MD&#39;</span><span class="p">,</span>
                         <span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.MD&#39;</span><span class="p">)</span>
    <span class="n">transfo_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;b0mean&#39;</span><span class="p">,</span>
                         <span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.b0mean&#39;</span><span class="p">)</span>
    <span class="n">transfo_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">compute_native_wm</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                         <span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.native_wm_mask&#39;</span><span class="p">)</span>

    <span class="c1"># apply norm to coreg_MD</span>
    <span class="n">norm_lin_MD</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">fsl</span><span class="o">.</span><span class="n">ApplyXFM</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;norm_lin_MD&quot;</span><span class="p">)</span>
    <span class="n">norm_lin_MD</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">params_template</span><span class="p">[</span><span class="s2">&quot;template_brain&quot;</span><span class="p">]</span>

    <span class="n">transfo_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.coreg_MD&#39;</span><span class="p">,</span>
                         <span class="n">norm_lin_MD</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
    <span class="n">transfo_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;lin_transfo_file&#39;</span><span class="p">,</span>
                         <span class="n">norm_lin_MD</span><span class="p">,</span> <span class="s1">&#39;in_matrix_file&#39;</span><span class="p">)</span>

    <span class="c1"># apply norm to coreg_better_MD</span>
    <span class="n">norm_lin_better_MD</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">fsl</span><span class="o">.</span><span class="n">ApplyXFM</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;norm_lin_better_MD&quot;</span><span class="p">)</span>
    <span class="n">norm_lin_better_MD</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">params_template</span><span class="p">[</span><span class="s2">&quot;template_brain&quot;</span><span class="p">]</span>

    <span class="n">transfo_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.coreg_better_MD&#39;</span><span class="p">,</span>
                         <span class="n">norm_lin_better_MD</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
    <span class="n">transfo_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;lin_transfo_file&#39;</span><span class="p">,</span>
                         <span class="n">norm_lin_better_MD</span><span class="p">,</span> <span class="s1">&#39;in_matrix_file&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">transfo_pipe</span>


<span class="c1">###############################################################################</span>
<span class="c1"># ANTS based segmentation (from Kepkee Loh / Julien Sein)</span>
<span class="c1"># (-soft ANTS)</span>
<span class="c1">###############################################################################</span>
<div class="viewcode-block" id="create_brain_extraction_pipe"><a class="viewcode-back" href="../../../generated/macapype.pipelines.full_pipelines.create_brain_extraction_pipe.html#macapype.pipelines.full_pipelines.create_brain_extraction_pipe">[docs]</a><span class="k">def</span> <span class="nf">create_brain_extraction_pipe</span><span class="p">(</span><span class="n">params_template</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span>
                                 <span class="n">name</span><span class="o">=</span><span class="s2">&quot;brain_extraction_pipe&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Description: Brain extraction with atlas-brex after debiasing</span>

<span class="sd">    Params:</span>

<span class="sd">    - correct_bias_pipe (see :class:`create_correct_bias_pipe \</span>
<span class="sd">    &lt;macapype.pipelines.correct_bias.create_correct_bias_pipe&gt;`)</span>
<span class="sd">    - extract_pipe (see `create_extract_pipe &lt;macapype.pipeline.\</span>
<span class="sd">    extract_brain.create_extract_pipe&gt;`)</span>


<span class="sd">    Inputs:</span>

<span class="sd">        inputnode:</span>

<span class="sd">            preproc_T1:</span>
<span class="sd">                preprocessed T1 file</span>

<span class="sd">            preproc_T2:</span>
<span class="sd">                preprocessed T2 file</span>

<span class="sd">            indiv_params (opt):</span>
<span class="sd">                dict with individuals parameters for some nodes</span>


<span class="sd">        arguments:</span>

<span class="sd">            params_template:</span>
<span class="sd">                dictionary of template files</span>

<span class="sd">            params:</span>
<span class="sd">                dictionary of node sub-parameters (from a json file)</span>

<span class="sd">            name:</span>
<span class="sd">                pipeline name (default = &quot;full_segment_pipe&quot;)</span>

<span class="sd">    Outputs:</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># creating pipeline</span>
    <span class="n">brain_extraction_pipe</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Creating input node</span>
    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;preproc_T1&#39;</span><span class="p">,</span> <span class="s1">&#39;preproc_T2&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;indiv_params&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">)</span>

    <span class="c1"># output node</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;debiased_T1&#39;</span><span class="p">,</span> <span class="s1">&#39;debiased_T2&#39;</span><span class="p">,</span>
                                      <span class="s2">&quot;brain_mask&quot;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="s2">&quot;correct_bias_pipe&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot;N4debias&quot;</span> <span class="ow">in</span>
                <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="s2">&quot;error, only one of correct_bias_pipe or N4debias </span><span class="se">\</span>
<span class="s2">                should be present&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;correct_bias_pipe&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># Correct_bias_T1_T2</span>
        <span class="n">correct_bias_pipe</span> <span class="o">=</span> <span class="n">create_correct_bias_pipe</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;correct_bias_pipe&quot;</span><span class="p">))</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;preproc_T1&#39;</span><span class="p">,</span>
                                      <span class="n">correct_bias_pipe</span><span class="p">,</span>
                                      <span class="s1">&#39;inputnode.preproc_T1&#39;</span><span class="p">)</span>
        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;preproc_T2&#39;</span><span class="p">,</span>
                                      <span class="n">correct_bias_pipe</span><span class="p">,</span>
                                      <span class="s1">&#39;inputnode.preproc_T2&#39;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">correct_bias_pipe</span><span class="p">,</span>
                                      <span class="s2">&quot;outputnode.debiased_T1&quot;</span><span class="p">,</span>
                                      <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;debiased_T1&quot;</span><span class="p">)</span>
        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">correct_bias_pipe</span><span class="p">,</span>
                                      <span class="s2">&quot;outputnode.debiased_T2&quot;</span><span class="p">,</span>
                                      <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;debiased_T2&quot;</span><span class="p">)</span>

        <span class="c1"># brain extraction</span>
        <span class="n">extract_pipe</span> <span class="o">=</span> <span class="n">create_extract_pipe</span><span class="p">(</span>
            <span class="n">params_template</span><span class="o">=</span><span class="n">params_template</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;extract_pipe&quot;</span><span class="p">))</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">correct_bias_pipe</span><span class="p">,</span>
                                      <span class="s2">&quot;outputnode.debiased_T1&quot;</span><span class="p">,</span>
                                      <span class="n">extract_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.restore_T1&quot;</span><span class="p">)</span>
        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">correct_bias_pipe</span><span class="p">,</span>
                                      <span class="s2">&quot;outputnode.debiased_T2&quot;</span><span class="p">,</span>
                                      <span class="n">extract_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.restore_T2&quot;</span><span class="p">)</span>
        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s2">&quot;indiv_params&quot;</span><span class="p">,</span>
                                      <span class="n">extract_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.indiv_params&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">extract_pipe</span><span class="p">,</span>
                                      <span class="s2">&quot;smooth_mask.out_file&quot;</span><span class="p">,</span>
                                      <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;brain_mask&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="s2">&quot;N4debias&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found N4debias in params.json&quot;</span><span class="p">)</span>

        <span class="c1"># N4 intensity normalization over T1</span>
        <span class="n">N4debias_T1</span> <span class="o">=</span> <span class="n">NodeParams</span><span class="p">(</span><span class="n">ants</span><span class="o">.</span><span class="n">N4BiasFieldCorrection</span><span class="p">(),</span>
                                 <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;N4debias&quot;</span><span class="p">),</span>
                                 <span class="n">name</span><span class="o">=</span><span class="s1">&#39;N4debias_T1&#39;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;preproc_T1&#39;</span><span class="p">,</span>
                                      <span class="n">N4debias_T1</span><span class="p">,</span> <span class="s2">&quot;input_image&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">inputnode</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span> <span class="n">parse_key</span><span class="p">,</span> <span class="s2">&quot;N4debias&quot;</span><span class="p">),</span>
            <span class="n">N4debias_T1</span><span class="p">,</span> <span class="s2">&quot;indiv_params&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">N4debias_T1</span><span class="p">,</span> <span class="s2">&quot;output_image&quot;</span><span class="p">,</span>
                                      <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;debiased_T1&quot;</span><span class="p">)</span>

        <span class="c1"># N4 intensity normalization over T2</span>
        <span class="n">N4debias_T2</span> <span class="o">=</span> <span class="n">NodeParams</span><span class="p">(</span><span class="n">ants</span><span class="o">.</span><span class="n">N4BiasFieldCorrection</span><span class="p">(),</span>
                                 <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;N4debias&quot;</span><span class="p">),</span>
                                 <span class="n">name</span><span class="o">=</span><span class="s1">&#39;N4debias_T2&#39;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;preproc_T2&#39;</span><span class="p">,</span>
                                      <span class="n">N4debias_T2</span><span class="p">,</span> <span class="s2">&quot;input_image&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">inputnode</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span> <span class="n">parse_key</span><span class="p">,</span> <span class="s2">&quot;N4debias&quot;</span><span class="p">),</span>
            <span class="n">N4debias_T2</span><span class="p">,</span> <span class="s2">&quot;indiv_params&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">N4debias_T2</span><span class="p">,</span> <span class="s2">&quot;output_image&quot;</span><span class="p">,</span>
                                      <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;debiased_T2&quot;</span><span class="p">)</span>

        <span class="c1"># brain extraction</span>
        <span class="n">extract_pipe</span> <span class="o">=</span> <span class="n">create_extract_pipe</span><span class="p">(</span>
            <span class="n">params_template</span><span class="o">=</span><span class="n">params_template</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;extract_pipe&quot;</span><span class="p">))</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">N4debias_T1</span><span class="p">,</span> <span class="s2">&quot;output_image&quot;</span><span class="p">,</span>
                                      <span class="n">extract_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.restore_T1&quot;</span><span class="p">)</span>
        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">N4debias_T2</span><span class="p">,</span> <span class="s2">&quot;output_image&quot;</span><span class="p">,</span>
                                      <span class="n">extract_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.restore_T2&quot;</span><span class="p">)</span>
        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s2">&quot;indiv_params&quot;</span><span class="p">,</span>
                                      <span class="n">extract_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.indiv_params&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">extract_pipe</span><span class="p">,</span>
                                      <span class="s2">&quot;smooth_mask.out_file&quot;</span><span class="p">,</span>
                                      <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;brain_mask&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s2">&quot;fast&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found fast in params.json&quot;</span><span class="p">)</span>

        <span class="c1"># fast over T1</span>
        <span class="n">fast_T1</span> <span class="o">=</span> <span class="n">NodeParams</span><span class="p">(</span>
            <span class="n">fsl</span><span class="o">.</span><span class="n">FAST</span><span class="p">(),</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;fast&quot;</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fast_T1&#39;</span><span class="p">)</span>

        <span class="n">fast_T1</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_biascorrected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">fast_T1</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_biasfield</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;preproc_T1&#39;</span><span class="p">,</span>
                                      <span class="n">fast_T1</span><span class="p">,</span> <span class="s2">&quot;in_files&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">inputnode</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span> <span class="n">parse_key</span><span class="p">,</span> <span class="s2">&quot;fast&quot;</span><span class="p">),</span>
            <span class="n">fast_T1</span><span class="p">,</span> <span class="s2">&quot;indiv_params&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fast_T1</span><span class="p">,</span> <span class="s2">&quot;restored_image&quot;</span><span class="p">,</span>
                                      <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;debiased_T1&quot;</span><span class="p">)</span>

        <span class="c1"># fast over T2</span>
        <span class="n">fast_T2</span> <span class="o">=</span> <span class="n">NodeParams</span><span class="p">(</span>
            <span class="n">fsl</span><span class="o">.</span><span class="n">FAST</span><span class="p">(),</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;fast&quot;</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fast_T2&#39;</span><span class="p">)</span>

        <span class="n">fast_T2</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_biascorrected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">fast_T2</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_biasfield</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;preproc_T2&#39;</span><span class="p">,</span>
                                      <span class="n">fast_T2</span><span class="p">,</span> <span class="s2">&quot;in_files&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">inputnode</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span> <span class="n">parse_key</span><span class="p">,</span> <span class="s2">&quot;fast&quot;</span><span class="p">),</span>
            <span class="n">fast_T2</span><span class="p">,</span> <span class="s2">&quot;indiv_params&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fast_T2</span><span class="p">,</span> <span class="s2">&quot;restored_image&quot;</span><span class="p">,</span>
                                      <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;debiased_T2&quot;</span><span class="p">)</span>
        <span class="c1"># brain extraction</span>
        <span class="n">extract_pipe</span> <span class="o">=</span> <span class="n">create_extract_pipe</span><span class="p">(</span>
            <span class="n">params_template</span><span class="o">=</span><span class="n">params_template</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;extract_pipe&quot;</span><span class="p">))</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fast_T1</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;restored_image&quot;</span><span class="p">,</span> <span class="n">show_files</span><span class="p">),</span>
                                      <span class="n">extract_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.restore_T1&quot;</span><span class="p">)</span>
        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fast_T2</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;restored_image&quot;</span><span class="p">,</span> <span class="n">show_files</span><span class="p">),</span>
                                      <span class="n">extract_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.restore_T2&quot;</span><span class="p">)</span>
        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s2">&quot;indiv_params&quot;</span><span class="p">,</span>
                                      <span class="n">extract_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.indiv_params&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">extract_pipe</span><span class="p">,</span>
                                      <span class="s2">&quot;smooth_mask.out_file&quot;</span><span class="p">,</span>
                                      <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;brain_mask&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No debias will be performed before extract_pipe&quot;</span><span class="p">)</span>

        <span class="c1"># brain extraction</span>
        <span class="n">extract_pipe</span> <span class="o">=</span> <span class="n">create_extract_pipe</span><span class="p">(</span>
            <span class="n">params_template</span><span class="o">=</span><span class="n">params_template</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;extract_pipe&quot;</span><span class="p">))</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s2">&quot;preproc_T1&quot;</span><span class="p">,</span>
                                      <span class="n">extract_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.restore_T1&quot;</span><span class="p">)</span>
        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s2">&quot;preproc_T2&quot;</span><span class="p">,</span>
                                      <span class="n">extract_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.restore_T2&quot;</span><span class="p">)</span>
        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s2">&quot;indiv_params&quot;</span><span class="p">,</span>
                                      <span class="n">extract_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.indiv_params&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">extract_pipe</span><span class="p">,</span>
                                      <span class="s2">&quot;smooth_mask.out_file&quot;</span><span class="p">,</span>
                                      <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;brain_mask&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">brain_extraction_pipe</span></div>


<div class="viewcode-block" id="create_brain_segment_from_mask_pipe"><a class="viewcode-back" href="../../../generated/macapype.pipelines.full_pipelines.create_brain_segment_from_mask_pipe.html#macapype.pipelines.full_pipelines.create_brain_segment_from_mask_pipe">[docs]</a><span class="k">def</span> <span class="nf">create_brain_segment_from_mask_pipe</span><span class="p">(</span>
        <span class="n">params_template</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;brain_segment_from_mask_pipe&quot;</span><span class="p">,</span>
        <span class="n">NMT_version</span><span class="o">=</span><span class="s2">&quot;v1.3&quot;</span><span class="p">,</span> <span class="n">space</span><span class="o">=</span><span class="s2">&quot;native&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Description: Segment T1 (using T2 for bias correction) and a previously</span>
<span class="sd">    computed mask with NMT Atlas and atropos segment.</span>

<span class="sd">    Params:</span>

<span class="sd">    - masked_correct_bias_pipe (see :class:`create_masked_correct_bias_pipe \</span>
<span class="sd">    &lt;macapype.pipelines.correct_bias.create_masked_correct_bias_pipe&gt;`)</span>
<span class="sd">    - register_NMT_pipe (see :class:`create_register_NMT_pipe \</span>
<span class="sd">    &lt;macapype.pipelines.register.create_register_NMT_pipe&gt;`)</span>
<span class="sd">    - segment_atropos_pipe (see :class:`create_segment_atropos_pipe \</span>
<span class="sd">    &lt;macapype.pipelines.segment.create_segment_atropos_pipe&gt;`)</span>

<span class="sd">    Inputs:</span>

<span class="sd">        inputnode:</span>

<span class="sd">            preproc_T1:</span>
<span class="sd">                preprocessed T1 file name</span>

<span class="sd">            preproc_T2:</span>
<span class="sd">                preprocessed T2 file name</span>

<span class="sd">            brain_mask:</span>
<span class="sd">                a mask computed for the same T1/T2 images</span>

<span class="sd">            indiv_params (opt):</span>
<span class="sd">                dict with individuals parameters for some nodes</span>


<span class="sd">        arguments:</span>

<span class="sd">            params_template:</span>
<span class="sd">                dictionary of template files</span>

<span class="sd">            params:</span>
<span class="sd">                dictionary of node sub-parameters (from a json file)</span>

<span class="sd">            name:</span>
<span class="sd">                pipeline name (default = &quot;full_segment_pipe&quot;)</span>

<span class="sd">    Outputs:</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># creating pipeline</span>
    <span class="n">brain_segment_pipe</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># creating inputnode</span>
    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;preproc_T1&#39;</span><span class="p">,</span> <span class="s1">&#39;preproc_T2&#39;</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">)</span>

    <span class="c1"># creating outputnode</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;segmented_file&quot;</span><span class="p">,</span> <span class="s2">&quot;threshold_gm&quot;</span><span class="p">,</span> <span class="s2">&quot;threshold_wm&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;threshold_csf&quot;</span><span class="p">,</span> <span class="s2">&quot;prob_gm&quot;</span><span class="p">,</span> <span class="s2">&quot;prob_wm&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;prob_csf&quot;</span><span class="p">,</span> <span class="s2">&quot;gen_5tt&quot;</span><span class="p">,</span> <span class="s2">&quot;debiased_brain&quot;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">)</span>

    <span class="c1"># correcting for bias T1/T2, but this time with a mask</span>
    <span class="k">if</span> <span class="s2">&quot;masked_correct_bias_pipe&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">masked_correct_bias_pipe</span> <span class="o">=</span> <span class="n">create_masked_correct_bias_pipe</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;masked_correct_bias_pipe&quot;</span><span class="p">))</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;preproc_T1&#39;</span><span class="p">,</span>
            <span class="n">masked_correct_bias_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.preproc_T1&quot;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;preproc_T2&#39;</span><span class="p">,</span>
            <span class="n">masked_correct_bias_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.preproc_T2&quot;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span>
            <span class="n">masked_correct_bias_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.brain_mask&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="s2">&quot;debias&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># Bias correction of cropped images</span>
        <span class="n">debias</span> <span class="o">=</span> <span class="n">NodeParams</span><span class="p">(</span><span class="n">T1xT2BiasFieldCorrection</span><span class="p">(),</span>
                            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;debias&quot;</span><span class="p">),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;debias&#39;</span><span class="p">)</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;preproc_T1&#39;</span><span class="p">,</span>
                                   <span class="n">debias</span><span class="p">,</span> <span class="s1">&#39;t1_file&#39;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;preproc_T2&#39;</span><span class="p">,</span>
                                   <span class="n">debias</span><span class="p">,</span> <span class="s1">&#39;t2_file&#39;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span>
                                   <span class="n">debias</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="c1"># TODO is not used now...</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">inputnode</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span> <span class="n">parse_key</span><span class="p">,</span> <span class="s2">&quot;debias&quot;</span><span class="p">),</span>
            <span class="n">debias</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;**** Error, masked_correct_bias_pipe or debias </span><span class="se">\</span>
<span class="s2">            should be in brain_extraction_pipe of params.json&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No T1*T2 debias will be performed&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;NMT_version&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#### NMT version for register_NMT_pipe AND seg_atropos&quot;</span><span class="p">)</span>
        <span class="n">NMT_version</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;NMT_version&quot;</span><span class="p">]</span>

    <span class="c1"># register NMT template, template mask and priors to subject T1</span>
    <span class="n">register_NMT_pipe</span> <span class="o">=</span> <span class="n">create_register_NMT_pipe</span><span class="p">(</span>
        <span class="n">params_template</span><span class="o">=</span><span class="n">params_template</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;register_NMT_pipe&quot;</span><span class="p">),</span> <span class="n">NMT_version</span><span class="o">=</span><span class="n">NMT_version</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;masked_correct_bias_pipe&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">masked_correct_bias_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.mask_debiased_T1&#39;</span><span class="p">,</span>
            <span class="n">register_NMT_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.T1&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="s2">&quot;debias&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">debias</span><span class="p">,</span> <span class="s1">&#39;t1_debiased_brain_file&#39;</span><span class="p">,</span>
            <span class="n">register_NMT_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.T1&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;preproc_T1&#39;</span><span class="p">,</span>
            <span class="n">register_NMT_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.T1&quot;</span><span class="p">)</span>

    <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
        <span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span>
        <span class="n">register_NMT_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.indiv_params&quot;</span><span class="p">)</span>

    <span class="c1"># ants Atropos</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For Atropos pipe, using NMT_version = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NMT_version</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">NMT_version</span> <span class="o">==</span> <span class="s2">&quot;v2.0&quot;</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#### create_segment_atropos_seg_pipe &quot;</span><span class="p">)</span>
        <span class="n">segment_atropos_pipe</span> <span class="o">=</span> <span class="n">create_segment_atropos_seg_pipe</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;segment_atropos_pipe&quot;</span><span class="p">))</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">register_NMT_pipe</span><span class="p">,</span> <span class="s1">&#39;align_seg.out_file&#39;</span><span class="p">,</span> <span class="n">segment_atropos_pipe</span><span class="p">,</span>
            <span class="s2">&quot;inputnode.seg_file&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#### create_segment_atropos_pipe (3 tissues) &quot;</span><span class="p">)</span>

        <span class="n">segment_atropos_pipe</span> <span class="o">=</span> <span class="n">create_segment_atropos_pipe</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;segment_atropos_pipe&quot;</span><span class="p">))</span>

        <span class="c1"># linking priors if &quot;use_priors&quot; in params</span>
        <span class="k">if</span> <span class="s2">&quot;use_priors&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;segment_atropos_pipe&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="n">register_NMT_pipe</span><span class="p">,</span> <span class="s1">&#39;align_seg_csf.out_file&#39;</span><span class="p">,</span>
                <span class="n">segment_atropos_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.csf_prior_file&quot;</span><span class="p">)</span>
            <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="n">register_NMT_pipe</span><span class="p">,</span> <span class="s1">&#39;align_seg_gm.out_file&#39;</span><span class="p">,</span>
                <span class="n">segment_atropos_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.gm_prior_file&quot;</span><span class="p">)</span>
            <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="n">register_NMT_pipe</span><span class="p">,</span> <span class="s1">&#39;align_seg_wm.out_file&#39;</span><span class="p">,</span>
                <span class="n">segment_atropos_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.wm_prior_file&quot;</span><span class="p">)</span>

    <span class="c1"># input to segment_atropos_pipe depending on T1T2 debias step</span>
    <span class="k">if</span> <span class="s2">&quot;masked_correct_bias_pipe&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">masked_correct_bias_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.mask_debiased_T1&#39;</span><span class="p">,</span>
            <span class="n">segment_atropos_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.brain_file&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s2">&quot;debias&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">debias</span><span class="p">,</span> <span class="s1">&#39;t1_debiased_brain_file&#39;</span><span class="p">,</span>
            <span class="n">segment_atropos_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.brain_file&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;preproc_T1&#39;</span><span class="p">,</span>
            <span class="n">segment_atropos_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.brain_file&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;export_5tt_pipe&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

        <span class="n">export_5tt_pipe</span> <span class="o">=</span> <span class="n">create_5tt_pipe</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;export_5tt_pipe&quot;</span><span class="p">))</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.threshold_gm&#39;</span><span class="p">,</span>
                                   <span class="n">export_5tt_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.gm_file&#39;</span><span class="p">)</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.threshold_wm&#39;</span><span class="p">,</span>
                                   <span class="n">export_5tt_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.wm_file&#39;</span><span class="p">)</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.threshold_csf&#39;</span><span class="p">,</span>
                                   <span class="n">export_5tt_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.csf_file&#39;</span><span class="p">)</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">export_5tt_pipe</span><span class="p">,</span> <span class="s1">&#39;export_5tt.gen_5tt_file&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;gen_5tt&#39;</span><span class="p">)</span>

    <span class="c1"># output prepreocessed brain T1</span>
    <span class="k">if</span> <span class="s2">&quot;masked_correct_bias_pipe&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">masked_correct_bias_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.mask_debiased_T1&#39;</span><span class="p">,</span>
            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;debiased_brain&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s2">&quot;debias&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">debias</span><span class="p">,</span> <span class="s1">&#39;t1_debiased_brain_file&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;debiased_brain&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;preproc_T1&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;debiased_brain&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;native&#39;</span><span class="p">:</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.segmented_file&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;segmented_file&#39;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.threshold_gm&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;threshold_gm&#39;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.threshold_wm&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;threshold_wm&#39;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.threshold_csf&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;threshold_csf&#39;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.prob_gm&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;prob_gm&#39;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.prob_wm&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;prob_wm&#39;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.prob_csf&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;prob_csf&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">reg_seg_pipe</span> <span class="o">=</span> <span class="n">create_reg_seg_pipe</span><span class="p">()</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.segmented_file&#39;</span><span class="p">,</span> <span class="n">reg_seg_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;inputnode.native_segmented_file&#39;</span><span class="p">)</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">register_NMT_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;NMT_subject_align.transfo_file&#39;</span><span class="p">,</span>
                                   <span class="n">reg_seg_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.transfo_file&#39;</span><span class="p">)</span>

        <span class="n">reg_seg_pipe</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputnode</span><span class="o">.</span><span class="n">ref_image</span> <span class="o">=</span> \
            <span class="n">params_template</span><span class="p">[</span><span class="s1">&#39;template_head&#39;</span><span class="p">]</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reg_seg_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.norm_seg&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;segmented_file&#39;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reg_seg_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.norm_gm&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;threshold_gm&#39;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reg_seg_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.norm_wm&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;threshold_wm&#39;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reg_seg_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.norm_csf&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;threshold_csf&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">brain_segment_pipe</span></div>


<div class="viewcode-block" id="create_full_ants_subpipes"><a class="viewcode-back" href="../../../generated/macapype.pipelines.full_pipelines.create_full_ants_subpipes.html#macapype.pipelines.full_pipelines.create_full_ants_subpipes">[docs]</a><span class="k">def</span> <span class="nf">create_full_ants_subpipes</span><span class="p">(</span>
        <span class="n">params_template</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;full_ants_subpipes&quot;</span><span class="p">,</span> <span class="n">mask_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">space</span><span class="o">=</span><span class="s2">&quot;native&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Description: Segment T1 (using T2 for bias correction) .</span>

<span class="sd">    Params:</span>

<span class="sd">    - short_data_preparation_pipe (see :class:`create_short_preparation_pipe \</span>
<span class="sd">    &lt;macapype.pipelines.prepare.create_short_preparation_pipe&gt;`) or \</span>
<span class="sd">    long_single_preparation_pipe \</span>
<span class="sd">    (see :class:`create_long_single_preparation_pipe \</span>
<span class="sd">    &lt;macapype.pipelines.prepare.create_long_single_preparation_pipe&gt;`) or \</span>
<span class="sd">    long_multi_preparation_pipe \</span>
<span class="sd">    (see :class:`create_long_multi_preparation_pipe \</span>
<span class="sd">    &lt;macapype.pipelines.prepare.create_long_multi_preparation_pipe&gt;`)</span>

<span class="sd">    - brain_extraction_pipe (see :class:`create_brain_extraction_pipe \</span>
<span class="sd">    &lt;macapype.pipelines.full_pipelines.create_brain_extraction_pipe&gt;`)</span>
<span class="sd">    - brain_segment_pipe (see :class:`create_brain_segment_from_mask_pipe\</span>
<span class="sd">    &lt;macapype.pipelines.full_pipelines.create_brain_segment_from_mask_pipe&gt;`)</span>
<span class="sd">    - nii_to_mesh_pipe (see :class:`create_nii_to_mesh_pipe\</span>
<span class="sd">    &lt;macapype.pipelines.surface.create_nii_to_mesh_pipe&gt;`)</span>

<span class="sd">    Inputs:</span>

<span class="sd">        inputnode:</span>

<span class="sd">            list_T1:</span>
<span class="sd">                preprocessed T1 file name</span>

<span class="sd">            list_T2:</span>
<span class="sd">                preprocessed T2 file name</span>

<span class="sd">            indiv_params (opt):</span>
<span class="sd">                dict with individuals parameters for some nodes</span>

<span class="sd">        arguments:</span>

<span class="sd">            params_template:</span>
<span class="sd">                dictionary of template files</span>

<span class="sd">            params:</span>
<span class="sd">                dictionary of node sub-parameters (from a json file)</span>

<span class="sd">            name:</span>
<span class="sd">                pipeline name (default = &quot;full_segment_pipe&quot;)</span>

<span class="sd">    Outputs:</span>

<span class="sd">        brain_mask</span>

<span class="sd">        segmented_brain_mask:</span>
<span class="sd">            indexed with tissue classes</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># creating pipeline</span>
    <span class="n">seg_pipe</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Creating input node</span>
    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;list_T1&#39;</span><span class="p">,</span> <span class="s1">&#39;list_T2&#39;</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span>
    <span class="p">)</span>

    <span class="c1"># output node</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;segmented_brain_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;prob_gm&#39;</span><span class="p">,</span> <span class="s1">&#39;prob_wm&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;prob_csf&#39;</span><span class="p">,</span> <span class="s2">&quot;gen_5tt&quot;</span><span class="p">,</span> <span class="s2">&quot;debiased_brain&quot;</span><span class="p">,</span> <span class="s2">&quot;debiased_T1&quot;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">)</span>

    <span class="c1"># preprocessing</span>
    <span class="k">if</span> <span class="s1">&#39;long_single_preparation_pipe&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">data_preparation_pipe</span> <span class="o">=</span> <span class="n">create_long_single_preparation_pipe</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;long_single_preparation_pipe&quot;</span><span class="p">))</span>

    <span class="k">elif</span> <span class="s1">&#39;long_multi_preparation_pipe&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">data_preparation_pipe</span> <span class="o">=</span> <span class="n">create_long_multi_preparation_pipe</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;long_multi_preparation_pipe&quot;</span><span class="p">))</span>

    <span class="k">elif</span> <span class="s1">&#39;short_preparation_pipe&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">data_preparation_pipe</span> <span class="o">=</span> <span class="n">create_short_preparation_pipe</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;short_preparation_pipe&quot;</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error, short_preparation_pipe, long_single_preparation_pipe or</span><span class="se">\</span>
<span class="s2">            long_multi_preparation_pipe was not found in params, skipping&quot;</span><span class="p">)</span>

        <span class="n">test_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;list_T1&#39;</span><span class="p">,</span> <span class="s1">&#39;list_T2&#39;</span><span class="p">],</span>
                                         <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span>
                                         <span class="n">function</span><span class="o">=</span><span class="n">list_input_files</span><span class="p">),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;test_node&quot;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;list_T1&#39;</span><span class="p">,</span>
                         <span class="n">test_node</span><span class="p">,</span> <span class="s1">&#39;list_T1&#39;</span><span class="p">)</span>
        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;list_T2&#39;</span><span class="p">,</span>
                         <span class="n">test_node</span><span class="p">,</span> <span class="s1">&#39;list_T2&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">seg_pipe</span>

    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;list_T1&#39;</span><span class="p">,</span>
                     <span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.list_T1&#39;</span><span class="p">)</span>
    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;list_T2&#39;</span><span class="p">,</span>
                     <span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.list_T2&#39;</span><span class="p">)</span>
    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span>
                     <span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.indiv_params&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mask_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># full extract brain pipeline (correct_bias, denoising, extract brain)</span>
        <span class="k">if</span> <span class="s2">&quot;brain_extraction_pipe&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">seg_pipe</span>

        <span class="n">brain_extraction_pipe</span> <span class="o">=</span> <span class="n">create_brain_extraction_pipe</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;brain_extraction_pipe&quot;</span><span class="p">),</span>
            <span class="n">params_template</span><span class="o">=</span><span class="n">params_template</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.preproc_T1&#39;</span><span class="p">,</span>
                         <span class="n">brain_extraction_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.preproc_T1&#39;</span><span class="p">)</span>
        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.preproc_T2&#39;</span><span class="p">,</span>
                         <span class="n">brain_extraction_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.preproc_T2&#39;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span>
                         <span class="n">brain_extraction_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.indiv_params&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pad</span> <span class="ow">and</span> <span class="n">space</span> <span class="o">==</span> <span class="s2">&quot;native&quot;</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Padding mask in native space&quot;</span><span class="p">)</span>

            <span class="n">pad_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                <span class="n">niu</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
                    <span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cropped_img_file&#39;</span><span class="p">,</span> <span class="s1">&#39;orig_img_file&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;indiv_crop&#39;</span><span class="p">],</span>
                    <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;padded_img_file&#39;</span><span class="p">],</span>
                    <span class="n">function</span><span class="o">=</span><span class="n">padding_cropped_img</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;pad_mask&quot;</span><span class="p">)</span>

            <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_extraction_pipe</span><span class="p">,</span> <span class="s2">&quot;outputnode.brain_mask&quot;</span><span class="p">,</span>
                             <span class="n">pad_mask</span><span class="p">,</span> <span class="s2">&quot;cropped_img_file&quot;</span><span class="p">)</span>

            <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s2">&quot;av_T1.avg_img&quot;</span><span class="p">,</span>
                             <span class="n">pad_mask</span><span class="p">,</span> <span class="s2">&quot;orig_img_file&quot;</span><span class="p">)</span>

            <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s2">&quot;indiv_params&quot;</span><span class="p">,</span> <span class="n">pad_mask</span><span class="p">,</span> <span class="s2">&quot;indiv_crop&quot;</span><span class="p">)</span>

            <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">pad_mask</span><span class="p">,</span> <span class="s2">&quot;padded_img_file&quot;</span><span class="p">,</span>
                             <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;brain_mask&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_extraction_pipe</span><span class="p">,</span> <span class="s2">&quot;outputnode.brain_mask&quot;</span><span class="p">,</span>
                             <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;brain_mask&quot;</span><span class="p">)</span>

            <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_extraction_pipe</span><span class="p">,</span> <span class="s2">&quot;outputnode.debiased_T1&quot;</span><span class="p">,</span>
                             <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;debiased_T1&quot;</span><span class="p">)</span>

    <span class="c1"># full_segment (restarting from the avg_align files)</span>
    <span class="k">if</span> <span class="s2">&quot;brain_segment_pipe&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">seg_pipe</span>

    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;template_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;NMT&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;found NMT template&quot;</span><span class="p">)</span>
        <span class="n">NMT_version</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;template_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not NMT template, NMT version used by default for processing&quot;</span><span class="p">)</span>
        <span class="n">NMT_version</span> <span class="o">=</span> <span class="s2">&quot;v1.3&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NMT_version:&quot;</span><span class="p">,</span> <span class="n">NMT_version</span><span class="p">)</span>

    <span class="n">brain_segment_pipe</span> <span class="o">=</span> <span class="n">create_brain_segment_from_mask_pipe</span><span class="p">(</span>
        <span class="n">params_template</span><span class="o">=</span><span class="n">params_template</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;brain_segment_pipe&quot;</span><span class="p">),</span>
        <span class="n">NMT_version</span><span class="o">=</span><span class="n">NMT_version</span><span class="p">,</span> <span class="n">space</span><span class="o">=</span><span class="n">space</span><span class="p">)</span>

    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_extraction_pipe</span><span class="p">,</span> <span class="s2">&quot;outputnode.debiased_T1&quot;</span><span class="p">,</span>
                     <span class="n">brain_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.preproc_T1&#39;</span><span class="p">)</span>
    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_extraction_pipe</span><span class="p">,</span> <span class="s2">&quot;outputnode.debiased_T2&quot;</span><span class="p">,</span>
                     <span class="n">brain_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.preproc_T2&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mask_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_extraction_pipe</span><span class="p">,</span>
                         <span class="s2">&quot;outputnode.brain_mask&quot;</span><span class="p">,</span>
                         <span class="n">brain_segment_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.brain_mask&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputnode</span><span class="o">.</span><span class="n">brain_mask</span> <span class="o">=</span> <span class="n">mask_file</span>

    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span>
                     <span class="n">brain_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.indiv_params&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pad</span> <span class="ow">and</span> <span class="n">space</span> <span class="o">==</span> <span class="s2">&quot;native&quot;</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Padding seg mask in native space&quot;</span><span class="p">)</span>

        <span class="n">pad_seg_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
            <span class="n">niu</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
                <span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cropped_img_file&#39;</span><span class="p">,</span> <span class="s1">&#39;orig_img_file&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;indiv_crop&#39;</span><span class="p">],</span>
                <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;padded_img_file&#39;</span><span class="p">],</span>
                <span class="n">function</span><span class="o">=</span><span class="n">padding_cropped_img</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;pad_seg_mask&quot;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.segmented_file&#39;</span><span class="p">,</span>
                         <span class="n">pad_seg_mask</span><span class="p">,</span> <span class="s2">&quot;cropped_img_file&quot;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s2">&quot;av_T1.avg_img&quot;</span><span class="p">,</span>
                         <span class="n">pad_seg_mask</span><span class="p">,</span> <span class="s2">&quot;orig_img_file&quot;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s2">&quot;indiv_params&quot;</span><span class="p">,</span> <span class="n">pad_seg_mask</span><span class="p">,</span> <span class="s2">&quot;indiv_crop&quot;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">pad_seg_mask</span><span class="p">,</span> <span class="s2">&quot;padded_img_file&quot;</span><span class="p">,</span>
                         <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;segmented_brain_mask&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.segmented_file&#39;</span><span class="p">,</span>
                         <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;segmented_brain_mask&#39;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.debiased_brain&#39;</span><span class="p">,</span>
                         <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;debiased_brain&quot;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.prob_csf&#39;</span><span class="p">,</span>
                         <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;prob_csf&#39;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.prob_gm&#39;</span><span class="p">,</span>
                         <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;prob_gm&#39;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.prob_wm&#39;</span><span class="p">,</span>
                         <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;prob_wm&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;export_5tt_pipe&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;brain_segment_pipe&quot;</span><span class="p">]:</span>

            <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.gen_5tt&#39;</span><span class="p">,</span>
                             <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;gen_5tt&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;nii_to_mesh_pipe&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

        <span class="n">nii_to_mesh_pipe</span> <span class="o">=</span> <span class="n">create_nii_to_mesh_pipe</span><span class="p">(</span>
            <span class="n">params_template</span><span class="o">=</span><span class="n">params_template</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;nii_to_mesh_pipe&quot;</span><span class="p">))</span>

        <span class="c1"># from data_preparation_pipe</span>
        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.preproc_T1&#39;</span><span class="p">,</span>
                         <span class="n">nii_to_mesh_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.t1_ref_file&#39;</span><span class="p">)</span>

        <span class="c1"># from brain_segment_pipe</span>
        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_segment_pipe</span><span class="p">,</span>
                         <span class="s1">&#39;register_NMT_pipe.NMT_subject_align.warpinv_file&#39;</span><span class="p">,</span>
                         <span class="n">nii_to_mesh_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.warpinv_file&#39;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">brain_segment_pipe</span><span class="p">,</span>
            <span class="s1">&#39;register_NMT_pipe.NMT_subject_align.inv_transfo_file&#39;</span><span class="p">,</span>
            <span class="n">nii_to_mesh_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.inv_transfo_file&#39;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_segment_pipe</span><span class="p">,</span>
                         <span class="s1">&#39;register_NMT_pipe.NMT_subject_align.aff_file&#39;</span><span class="p">,</span>
                         <span class="n">nii_to_mesh_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.aff_file&#39;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_segment_pipe</span><span class="p">,</span>
                         <span class="s1">&#39;segment_atropos_pipe.outputnode.segmented_file&#39;</span><span class="p">,</span>
                         <span class="n">nii_to_mesh_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.segmented_file&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="s2">&quot;nii_to_mesh_fs_pipe&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">nii_to_mesh_fs_pipe</span> <span class="o">=</span> <span class="n">create_nii_to_mesh_fs_pipe</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;nii_to_mesh_fs_pipe&quot;</span><span class="p">))</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_extraction_pipe</span><span class="p">,</span>
                         <span class="s1">&#39;outputnode.debiased_T1&#39;</span><span class="p">,</span>
                         <span class="n">nii_to_mesh_fs_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.reg_brain_file&#39;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_segment_pipe</span><span class="p">,</span>
                         <span class="s1">&#39;segment_atropos_pipe.outputnode.threshold_wm&#39;</span><span class="p">,</span>
                         <span class="n">nii_to_mesh_fs_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.wm_mask_file&#39;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span>
                         <span class="n">nii_to_mesh_fs_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.indiv_params&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">seg_pipe</span></div>


<span class="c1">###############################################################################</span>
<span class="c1"># ANTS based segmentation for adrien baboons (T1 without T2)</span>
<span class="c1"># -soft ANTS_T1</span>
<span class="c1">###############################################################################</span>
<span class="c1"># same as above, but replacing biascorrection with N4biascorrection</span>
<span class="c1"># in brain extraction and brain segmentation</span>
<div class="viewcode-block" id="create_brain_extraction_T1_pipe"><a class="viewcode-back" href="../../../generated/macapype.pipelines.full_pipelines.create_brain_extraction_T1_pipe.html#macapype.pipelines.full_pipelines.create_brain_extraction_T1_pipe">[docs]</a><span class="k">def</span> <span class="nf">create_brain_extraction_T1_pipe</span><span class="p">(</span><span class="n">params_template</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span>
                                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;brain_extraction_T1_pipe&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Brain extraction with only T1 images.</span>

<span class="sd">    - extract_T1_pipe (see `create_extract_T1_pipe &lt;macapype.pipeline.\</span>
<span class="sd">    extract_brain.create_extract_T1_pipe&gt;`)</span>

<span class="sd">    Inputs:</span>

<span class="sd">        inputnode:</span>

<span class="sd">            preproc_T1:</span>
<span class="sd">                preprocessed T1 file</span>

<span class="sd">            indiv_params (opt):</span>
<span class="sd">                dict with individuals parameters for some nodes</span>

<span class="sd">        arguments:</span>

<span class="sd">            params_template:</span>
<span class="sd">                dictionary of template files</span>

<span class="sd">            params:</span>
<span class="sd">                dictionary of node sub-parameters (from a json file)</span>

<span class="sd">            name:</span>
<span class="sd">                pipeline name (default = &quot;full_segment_pipe&quot;)</span>

<span class="sd">    Outputs:</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># creating pipeline</span>
    <span class="n">brain_extraction_pipe</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Creating input node</span>
    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;preproc_T1&#39;</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">)</span>

    <span class="c1"># Creating output node</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;debiased_T1&#39;</span><span class="p">,</span> <span class="s2">&quot;brain_mask&quot;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;N4debias&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found N4debias in params.json&quot;</span><span class="p">)</span>

        <span class="c1"># N4 intensity normalization over T1</span>
        <span class="n">N4debias_T1</span> <span class="o">=</span> <span class="n">NodeParams</span><span class="p">(</span><span class="n">ants</span><span class="o">.</span><span class="n">N4BiasFieldCorrection</span><span class="p">(),</span>
                                 <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;N4debias&quot;</span><span class="p">),</span>
                                 <span class="n">name</span><span class="o">=</span><span class="s1">&#39;N4debias_T1&#39;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;preproc_T1&#39;</span><span class="p">,</span>
                                      <span class="n">N4debias_T1</span><span class="p">,</span> <span class="s2">&quot;input_image&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">inputnode</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span> <span class="n">parse_key</span><span class="p">,</span> <span class="s2">&quot;N4debias&quot;</span><span class="p">),</span>
            <span class="n">N4debias_T1</span><span class="p">,</span> <span class="s2">&quot;indiv_params&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">N4debias_T1</span><span class="p">,</span> <span class="s2">&quot;output_image&quot;</span><span class="p">,</span>
                                      <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;debiased_T1&quot;</span><span class="p">)</span>

        <span class="c1"># brain extraction</span>
        <span class="n">extract_T1_pipe</span> <span class="o">=</span> <span class="n">create_extract_T1_pipe</span><span class="p">(</span>
            <span class="n">params_template</span><span class="o">=</span><span class="n">params_template</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;extract_pipe&quot;</span><span class="p">))</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">N4debias_T1</span><span class="p">,</span> <span class="s2">&quot;output_image&quot;</span><span class="p">,</span>
                                      <span class="n">extract_T1_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.restore_T1&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">inputnode</span><span class="p">,</span> <span class="s2">&quot;indiv_params&quot;</span><span class="p">,</span>
            <span class="n">extract_T1_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.indiv_params&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">extract_T1_pipe</span><span class="p">,</span>
                                      <span class="s2">&quot;smooth_mask.out_file&quot;</span><span class="p">,</span>
                                      <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;brain_mask&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="s2">&quot;fast&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found fast in params.json&quot;</span><span class="p">)</span>

        <span class="c1"># fast over T1</span>
        <span class="n">fast_T1</span> <span class="o">=</span> <span class="n">NodeParams</span><span class="p">(</span>
            <span class="n">fsl</span><span class="o">.</span><span class="n">FAST</span><span class="p">(),</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;fast&quot;</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fast_T1&#39;</span><span class="p">)</span>

        <span class="n">fast_T1</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_biascorrected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">fast_T1</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_biasfield</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;preproc_T1&#39;</span><span class="p">,</span>
                                      <span class="n">fast_T1</span><span class="p">,</span> <span class="s2">&quot;in_files&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">inputnode</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span> <span class="n">parse_key</span><span class="p">,</span> <span class="s2">&quot;fast&quot;</span><span class="p">),</span>
            <span class="n">fast_T1</span><span class="p">,</span> <span class="s2">&quot;indiv_params&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fast_T1</span><span class="p">,</span> <span class="s2">&quot;restored_image&quot;</span><span class="p">,</span>
                                      <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;debiased_T1&quot;</span><span class="p">)</span>

        <span class="c1"># brain extraction</span>
        <span class="n">extract_T1_pipe</span> <span class="o">=</span> <span class="n">create_extract_T1_pipe</span><span class="p">(</span>
            <span class="n">params_template</span><span class="o">=</span><span class="n">params_template</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;extract_pipe&quot;</span><span class="p">))</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">fast_T1</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;restored_image&quot;</span><span class="p">,</span> <span class="n">show_files</span><span class="p">),</span>
            <span class="n">extract_T1_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.restore_T1&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">inputnode</span><span class="p">,</span> <span class="s2">&quot;indiv_params&quot;</span><span class="p">,</span>
            <span class="n">extract_T1_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.indiv_params&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">extract_T1_pipe</span><span class="p">,</span>
                                      <span class="s2">&quot;smooth_mask.out_file&quot;</span><span class="p">,</span>
                                      <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;brain_mask&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s2">&quot;preproc_T1&quot;</span><span class="p">,</span>
                                      <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;debiased_T1&quot;</span><span class="p">)</span>

        <span class="c1"># brain extraction (with atlasbrex)</span>
        <span class="n">extract_T1_pipe</span> <span class="o">=</span> <span class="n">create_extract_T1_pipe</span><span class="p">(</span>
            <span class="n">params_template</span><span class="o">=</span><span class="n">params_template</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;extract_pipe&quot;</span><span class="p">))</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">inputnode</span><span class="p">,</span> <span class="s2">&quot;preproc_T1&quot;</span><span class="p">,</span>
            <span class="n">extract_T1_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.restore_T1&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">inputnode</span><span class="p">,</span> <span class="s2">&quot;indiv_params&quot;</span><span class="p">,</span>
            <span class="n">extract_T1_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.indiv_params&quot;</span><span class="p">)</span>

        <span class="n">brain_extraction_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">extract_T1_pipe</span><span class="p">,</span>
                                      <span class="s2">&quot;smooth_mask.out_file&quot;</span><span class="p">,</span>
                                      <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;brain_mask&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">brain_extraction_pipe</span></div>


<div class="viewcode-block" id="create_brain_segment_from_mask_T1_pipe"><a class="viewcode-back" href="../../../generated/macapype.pipelines.full_pipelines.create_brain_segment_from_mask_T1_pipe.html#macapype.pipelines.full_pipelines.create_brain_segment_from_mask_T1_pipe">[docs]</a><span class="k">def</span> <span class="nf">create_brain_segment_from_mask_T1_pipe</span><span class="p">(</span>
        <span class="n">params_template</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;brain_segment_from_mask_T1_pipe&quot;</span><span class="p">,</span>
        <span class="n">space</span><span class="o">=</span><span class="s2">&quot;native&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Segment T1 from a previously computed mask.</span>

<span class="sd">    Params:</span>

<span class="sd">    - register_NMT_pipe (see :class:`create_register_NMT_pipe \</span>
<span class="sd">    &lt;macapype.pipelines.register.create_register_NMT_pipe&gt;`)</span>
<span class="sd">    - segment_atropos_pipe (see :class:`create_segment_atropos_pipe \</span>
<span class="sd">    &lt;macapype.pipelines.segment.create_segment_atropos_pipe&gt;`)</span>

<span class="sd">    Inputs:</span>

<span class="sd">        inputnode:</span>

<span class="sd">            preproc_T1:</span>
<span class="sd">                preprocessed T1 file name</span>

<span class="sd">            brain_mask:</span>
<span class="sd">                a mask computed for the same T1/T2 images</span>

<span class="sd">            indiv_params (opt):</span>
<span class="sd">                dict with individuals parameters for some nodes</span>


<span class="sd">        arguments:</span>

<span class="sd">            params_template:</span>
<span class="sd">                dictionary of template files</span>

<span class="sd">            params:</span>
<span class="sd">                dictionary of node sub-parameters (from a json file)</span>

<span class="sd">            name:</span>
<span class="sd">                pipeline name (default = &quot;full_segment_pipe&quot;)</span>

<span class="sd">    Outputs:</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># creating pipeline</span>
    <span class="n">brain_segment_pipe</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># creating inputnode</span>
    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;preproc_T1&#39;</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">)</span>

    <span class="c1"># creating outputnode</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;segmented_file&quot;</span><span class="p">,</span> <span class="s2">&quot;threshold_gm&quot;</span><span class="p">,</span> <span class="s2">&quot;threshold_wm&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;threshold_csf&quot;</span><span class="p">,</span> <span class="s2">&quot;prob_gm&quot;</span><span class="p">,</span> <span class="s2">&quot;prob_wm&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;prob_csf&quot;</span><span class="p">,</span> <span class="s2">&quot;gen_5tt&quot;</span><span class="p">,</span> <span class="s2">&quot;debiased_brain&quot;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">)</span>

    <span class="c1"># mask T1 using brain mask and perform N4 bias correction</span>

    <span class="c1"># restore_mask_T1</span>
    <span class="n">restore_mask_T1</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">fsl</span><span class="o">.</span><span class="n">ApplyMask</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;restore_mask_T1&#39;</span><span class="p">)</span>

    <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;preproc_T1&#39;</span><span class="p">,</span>
                               <span class="n">restore_mask_T1</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
    <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span>
                               <span class="n">restore_mask_T1</span><span class="p">,</span> <span class="s1">&#39;mask_file&#39;</span><span class="p">)</span>

    <span class="n">NMT_version</span> <span class="o">=</span> <span class="s2">&quot;v1.3&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NMT_version:&quot;</span><span class="p">,</span> <span class="n">NMT_version</span><span class="p">)</span>

    <span class="c1"># register NMT template, template mask and priors to subject T1</span>
    <span class="n">register_NMT_pipe</span> <span class="o">=</span> <span class="n">create_register_NMT_pipe</span><span class="p">(</span>
        <span class="n">params_template</span><span class="o">=</span><span class="n">params_template</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;register_NMT_pipe&quot;</span><span class="p">),</span> <span class="n">NMT_version</span><span class="o">=</span><span class="n">NMT_version</span><span class="p">)</span>

    <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
        <span class="n">restore_mask_T1</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
        <span class="n">register_NMT_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.T1&quot;</span><span class="p">)</span>
    <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
        <span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span>
        <span class="n">register_NMT_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.indiv_params&quot;</span><span class="p">)</span>

    <span class="c1"># ants Atropos</span>
    <span class="n">segment_atropos_pipe</span> <span class="o">=</span> <span class="n">create_segment_atropos_pipe</span><span class="p">(</span>
        <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;segment_atropos_pipe&quot;</span><span class="p">))</span>

    <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
        <span class="n">restore_mask_T1</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
        <span class="n">segment_atropos_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.brain_file&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;use_priors&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;segment_atropos_pipe&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">register_NMT_pipe</span><span class="p">,</span> <span class="s1">&#39;align_seg_csf.out_file&#39;</span><span class="p">,</span>
                                   <span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s2">&quot;inputnode.csf_prior_file&quot;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">register_NMT_pipe</span><span class="p">,</span> <span class="s1">&#39;align_seg_gm.out_file&#39;</span><span class="p">,</span>
                                   <span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s2">&quot;inputnode.gm_prior_file&quot;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">register_NMT_pipe</span><span class="p">,</span> <span class="s1">&#39;align_seg_wm.out_file&#39;</span><span class="p">,</span>
                                   <span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s2">&quot;inputnode.wm_prior_file&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;export_5tt_pipe&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

        <span class="n">export_5tt_pipe</span> <span class="o">=</span> <span class="n">create_5tt_pipe</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;export_5tt_pipe&quot;</span><span class="p">))</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.threshold_gm&#39;</span><span class="p">,</span>
                                   <span class="n">export_5tt_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.gm_file&#39;</span><span class="p">)</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.threshold_wm&#39;</span><span class="p">,</span>
                                   <span class="n">export_5tt_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.wm_file&#39;</span><span class="p">)</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.threshold_csf&#39;</span><span class="p">,</span>
                                   <span class="n">export_5tt_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.csf_file&#39;</span><span class="p">)</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">export_5tt_pipe</span><span class="p">,</span> <span class="s1">&#39;export_5tt.gen_5tt_file&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;gen_5tt&#39;</span><span class="p">)</span>

    <span class="c1"># output prepreocessed brain T1</span>
    <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
        <span class="n">restore_mask_T1</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;debiased_brain&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;native&#39;</span><span class="p">:</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.segmented_file&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;segmented_file&#39;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.threshold_gm&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;threshold_gm&#39;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.threshold_wm&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;threshold_wm&#39;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.threshold_csf&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;threshold_csf&#39;</span><span class="p">)</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.prob_gm&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;prob_gm&#39;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.prob_wm&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;prob_wm&#39;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.prob_csf&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;prob_csf&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># TODO</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;!!!!!!!!!!!!!!!! Not finished yet !!!!!!!!!!!!!!!!!!!!!!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">brain_segment_pipe</span>

        <span class="n">reg_seg_pipe</span> <span class="o">=</span> <span class="n">create_reg_seg_pipe</span><span class="p">()</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">segment_atropos_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;outputnode.segmented_file&#39;</span><span class="p">,</span> <span class="n">reg_seg_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;inputnode.native_segmented_file&#39;</span><span class="p">)</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">register_NMT_pipe</span><span class="p">,</span>
                                   <span class="s1">&#39;NMT_subject_align.transfo_file&#39;</span><span class="p">,</span>
                                   <span class="n">reg_seg_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.transfo_file&#39;</span><span class="p">)</span>

        <span class="n">reg_seg_pipe</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputnode</span><span class="o">.</span><span class="n">ref_image</span> <span class="o">=</span> \
            <span class="n">params_template</span><span class="p">[</span><span class="s1">&#39;template_head&#39;</span><span class="p">]</span>

        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reg_seg_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.norm_seg&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;segmented_file&#39;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reg_seg_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.norm_gm&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;threshold_gm&#39;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reg_seg_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.norm_wm&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;threshold_wm&#39;</span><span class="p">)</span>
        <span class="n">brain_segment_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reg_seg_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.norm_csf&#39;</span><span class="p">,</span>
                                   <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;threshold_csf&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">brain_segment_pipe</span></div>


<div class="viewcode-block" id="create_full_T1_ants_subpipes"><a class="viewcode-back" href="../../../generated/macapype.pipelines.full_pipelines.create_full_T1_ants_subpipes.html#macapype.pipelines.full_pipelines.create_full_T1_ants_subpipes">[docs]</a><span class="k">def</span> <span class="nf">create_full_T1_ants_subpipes</span><span class="p">(</span><span class="n">params_template</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span>
                                 <span class="n">name</span><span class="o">=</span><span class="s2">&quot;full_T1_ants_subpipes&quot;</span><span class="p">,</span> <span class="n">space</span><span class="o">=</span><span class="s2">&quot;native&quot;</span><span class="p">,</span>
                                 <span class="n">pad</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Description: Full pipeline to segment T1 (with no T2).</span>

<span class="sd">    Params:</span>

<span class="sd">    - short_data_preparation_pipe (see :class:`create_short_preparation_pipe &lt;\</span>
<span class="sd">    macapype.pipelines.prepare.create_short_preparation_pipe&gt;`</span>
<span class="sd">    - brain_extraction_T1_pipe (see :class:`create_brain_extraction_T1_pipe \</span>
<span class="sd">    &lt;macapype.pipelines.full_pipelines.create_brain_extraction_T1_pipe&gt;`)</span>
<span class="sd">    - brain_segment_T1_pipe (see \</span>
<span class="sd">    :class:`create_brain_segment_from_mask_T1_pipe \</span>
<span class="sd">&lt;macapype.pipelines.full_pipelines.create_brain_segment_from_mask_T1_pipe&gt;`)</span>

<span class="sd">    Inputs:</span>

<span class="sd">        inputnode:</span>

<span class="sd">            list_T1:</span>
<span class="sd">                preprocessed T1 file name</span>

<span class="sd">            indiv_params (opt):</span>
<span class="sd">                dict with individuals parameters for some nodes</span>

<span class="sd">        arguments:</span>

<span class="sd">            params_template:</span>
<span class="sd">                dictionary of template files</span>

<span class="sd">            params:</span>
<span class="sd">                dictionary of node sub-parameters (from a json file)</span>

<span class="sd">            name:</span>
<span class="sd">                pipeline name (default = &quot;full_segment_pipe&quot;)</span>

<span class="sd">    Outputs:</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># creating pipeline</span>
    <span class="n">seg_pipe</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Creating input node (grab only T1 files)</span>
    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;list_T1&#39;</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputnode&#39;</span><span class="p">)</span>

    <span class="c1"># output node</span>
    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
        <span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;segmented_brain_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;prob_gm&#39;</span><span class="p">,</span> <span class="s1">&#39;prob_wm&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;prob_csf&#39;</span><span class="p">,</span> <span class="s2">&quot;gen_5tt&quot;</span><span class="p">,</span> <span class="s2">&quot;debiased_brain&quot;</span><span class="p">,</span> <span class="s2">&quot;debiased_T1&quot;</span><span class="p">]),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputnode&#39;</span><span class="p">)</span>

    <span class="c1"># preprocessing (perform preparation pipe with only T1)</span>
    <span class="k">if</span> <span class="s1">&#39;short_preparation_pipe&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">data_preparation_pipe</span> <span class="o">=</span> <span class="n">create_short_preparation_T1_pipe</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;short_preparation_pipe&quot;</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error, short_preparation_pipe was not found in params, </span><span class="se">\</span>
<span class="s2">            skipping&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">seg_pipe</span>

    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;list_T1&#39;</span><span class="p">,</span>
                     <span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.list_T1&#39;</span><span class="p">)</span>
    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span>
                     <span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.indiv_params&#39;</span><span class="p">)</span>

    <span class="c1"># full extract brain pipeline (correct_bias, denoising, extract brain)</span>
    <span class="k">if</span> <span class="s2">&quot;brain_extraction_pipe&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error, brain_extraction_pipe was not found in params, </span><span class="se">\</span>
<span class="s2">            skipping&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">seg_pipe</span>

    <span class="n">brain_extraction_pipe</span> <span class="o">=</span> <span class="n">create_brain_extraction_T1_pipe</span><span class="p">(</span>
        <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;brain_extraction_pipe&quot;</span><span class="p">),</span>
        <span class="n">params_template</span><span class="o">=</span><span class="n">params_template</span><span class="p">)</span>

    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.preproc_T1&#39;</span><span class="p">,</span>
                     <span class="n">brain_extraction_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.preproc_T1&#39;</span><span class="p">)</span>
    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span>
                     <span class="n">brain_extraction_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.indiv_params&#39;</span><span class="p">)</span>

    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_extraction_pipe</span><span class="p">,</span>
                     <span class="s2">&quot;outputnode.brain_mask&quot;</span><span class="p">,</span>
                     <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;brain_mask&quot;</span><span class="p">)</span>

    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_extraction_pipe</span><span class="p">,</span> <span class="s2">&quot;outputnode.debiased_T1&quot;</span><span class="p">,</span>
                     <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;debiased_T1&quot;</span><span class="p">)</span>

    <span class="c1"># full_segment (restarting from the avg_align files)</span>
    <span class="k">if</span> <span class="s2">&quot;brain_segment_pipe&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error, brain_segment_pipe was not found in params, </span><span class="se">\</span>
<span class="s2">            skipping&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">seg_pipe</span>

    <span class="n">brain_segment_pipe</span> <span class="o">=</span> <span class="n">create_brain_segment_from_mask_T1_pipe</span><span class="p">(</span>
        <span class="n">params_template</span><span class="o">=</span><span class="n">params_template</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;brain_segment_pipe&quot;</span><span class="p">),</span> <span class="n">space</span><span class="o">=</span><span class="n">space</span><span class="p">)</span>

    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_extraction_pipe</span><span class="p">,</span> <span class="s2">&quot;outputnode.debiased_T1&quot;</span><span class="p">,</span>
                     <span class="n">brain_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.preproc_T1&#39;</span><span class="p">)</span>
    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_extraction_pipe</span><span class="p">,</span>
                     <span class="s2">&quot;extract_T1_pipe.smooth_mask.out_file&quot;</span><span class="p">,</span>
                     <span class="n">brain_segment_pipe</span><span class="p">,</span> <span class="s2">&quot;inputnode.brain_mask&quot;</span><span class="p">)</span>
    <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span>
                     <span class="n">brain_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.indiv_params&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pad</span> <span class="ow">and</span> <span class="n">space</span> <span class="o">==</span> <span class="s2">&quot;native&quot;</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Padding seg mask in native space&quot;</span><span class="p">)</span>

        <span class="n">pad_seg_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
            <span class="n">niu</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
                <span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cropped_img_file&#39;</span><span class="p">,</span> <span class="s1">&#39;orig_img_file&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;indiv_crop&#39;</span><span class="p">],</span>
                <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;padded_img_file&#39;</span><span class="p">],</span>
                <span class="n">function</span><span class="o">=</span><span class="n">padding_cropped_img</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;pad_seg_mask&quot;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.segmented_file&#39;</span><span class="p">,</span>
                         <span class="n">pad_seg_mask</span><span class="p">,</span> <span class="s2">&quot;cropped_img_file&quot;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s2">&quot;av_T1.avg_img&quot;</span><span class="p">,</span>
                         <span class="n">pad_seg_mask</span><span class="p">,</span> <span class="s2">&quot;orig_img_file&quot;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s2">&quot;indiv_params&quot;</span><span class="p">,</span> <span class="n">pad_seg_mask</span><span class="p">,</span> <span class="s2">&quot;indiv_crop&quot;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">pad_seg_mask</span><span class="p">,</span> <span class="s2">&quot;padded_img_file&quot;</span><span class="p">,</span>
                         <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;segmented_brain_mask&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.segmented_file&#39;</span><span class="p">,</span>
                         <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;segmented_brain_mask&#39;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.debiased_brain&#39;</span><span class="p">,</span>
                         <span class="n">outputnode</span><span class="p">,</span> <span class="s2">&quot;debiased_brain&quot;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.prob_csf&#39;</span><span class="p">,</span>
                         <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;prob_csf&#39;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.prob_gm&#39;</span><span class="p">,</span>
                         <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;prob_gm&#39;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.prob_wm&#39;</span><span class="p">,</span>
                         <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;prob_wm&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;export_5tt_pipe&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;brain_segment_pipe&quot;</span><span class="p">]:</span>

            <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_segment_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.gen_5tt&#39;</span><span class="p">,</span>
                             <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;gen_5tt&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;nii_to_mesh_fs_pipe&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">nii_to_mesh_fs_pipe</span> <span class="o">=</span> <span class="n">create_nii_to_mesh_fs_pipe</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parse_key</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;nii_to_mesh_fs_pipe&quot;</span><span class="p">))</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">data_preparation_pipe</span><span class="p">,</span> <span class="s1">&#39;outputnode.preproc_T1&#39;</span><span class="p">,</span>
                         <span class="n">nii_to_mesh_fs_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.reg_brain_file&#39;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_segment_pipe</span><span class="p">,</span>
                         <span class="s1">&#39;segment_atropos_pipe.outputnode.threshold_wm&#39;</span><span class="p">,</span>
                         <span class="n">nii_to_mesh_fs_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.wm_mask_file&#39;</span><span class="p">)</span>

        <span class="n">seg_pipe</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;indiv_params&#39;</span><span class="p">,</span>
                         <span class="n">nii_to_mesh_fs_pipe</span><span class="p">,</span> <span class="s1">&#39;inputnode.indiv_params&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">seg_pipe</span></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2022, Macapype Developers (macatools). Last updated on 2022-04-12.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.3.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>